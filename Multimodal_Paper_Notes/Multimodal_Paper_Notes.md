# Mitigating Object Hallucinations in Large Vision-Language Models through  Visual Contrastive Decoding

当视觉输入质量较低时，多模态大模型的幻觉主要来源于其预训练时学习到的语言先验知识，即模型更倾向于生成符合常识但未必真实存在的对象

为了抑制这种幻觉，VCD方法通过对比原始图像和人为添加噪音后的图像在模型中的 logits 变化，来检测和削弱幻觉对象. 在这个过程中，采用 APC(自适应合理性约束), 即在扭曲图像中仅考察原始图像下logits置信度较高的对象(置信度较低的token在添加噪音的图像中不被允许生成)。这样可以避免误惩罚合理的预测

如果某类信息的 logits 在扭曲图像下明显上升，则表明该信息更可能是由语言先验引发的幻觉，而非真实视觉输入的结果

因此，我们可以针对这些幻觉信息进行抑制，从而提高模型的生成质量和可靠性

VCD是一种用于**推理**阶段的方法
## VCD

![alt text](image.png)

VCD（Visual Contrastive Decoding，视觉对比解码）基于对比模型在原始视觉输入 $V$ 和扭曲视觉输入 $V'$ 下的 logits（未归一化分数），通过抑制那些更容易出现在 $V'$ 中但在 $V$ 中可能是错误的对象，提高生成内容的可靠性。

在 VCD 过程中，首先模型基于原始视觉输入 $V$ 计算 logits，即 $\text{logits}(y|x, V)$，表示模型在真实视觉信息下对不同类别的置信度估计。同时，模型还会基于扭曲视觉输入 $V'$ 计算 $\text{logits}(y|x, V')$，其中 $V'$ 经过扰动或模糊化，可能导致模型错误地预测某些对象，增加幻觉现象。

VCD 通过以下公式进行对比计算：
$$
(1 + \alpha) \cdot \text{logits}(y|x, V) - \alpha \cdot \text{logits}(y|x, V')
$$
其中，$\alpha$ 是一个权重参数。该公式的作用是：

1. **增强原始视觉输入 $V$ 的 logits**，使基于真实视觉信息的预测更可靠；
2. **抑制扭曲视觉输入 $V'$ 的 logits**，削弱那些受噪声影响较大的对象；
3. **通过对比策略识别幻觉对象**，如果一个对象在 $V'$ 中的 logits 较高但在 $V$ 中较低，说明它可能是错误预测的幻觉，从而被去除。

这种方法的核心思想是利用扭曲输入 $V'$ 来检测模型的幻觉模式。由于真实存在的对象通常在 $V$ 和 $V'$ 中的 logits 变化较小，而幻觉对象在 $V'$ 中的 logits 可能更高，因此通过这种对比操作，可以有效减少生成内容中的错误预测。例如，在海滩场景下，"Surfboards"（冲浪板）可能是因模型的先验偏见而产生的幻觉，但在 VCD 计算后，该对象被成功去除，使生成的内容更加真实可信。

VCD 的优势在于，它不依赖额外的人工标注或监督学习，而是利用输入数据自身的信息进行优化

**VCD是一种推理阶段的方法, 它不改变模型的训练参数, 而是直接在解码过程中调整logits. 扭曲输入 $V'$也是在推理过程中现场生成的**

## 幻觉的来源

![alt text](image-1.png)


原图是一张黑色香蕉, 但是当图片被模糊之后, 模型识别香蕉颜色为黄色或绿色的logits就上升了. 这是因为LLM预训练的语言知识更倾向于认为香蕉是绿色或者黄色的

当视觉信息变得模糊或扭曲时，多模态大模型（LVLMs, Large Vision-Language Models）更依赖语言知识，而非视觉输入

**预训练数据集中的高频对象更容易在扭曲视觉输入下被幻觉化**, 由于 LVLMs 在训练过程中学习到了某些对象的高频性，当视觉输入质量下降时，模型倾向于“猜测”常见对象的存在，而不是依赖实际视觉信息。

## APC


VCD 通过对比原始视觉输入 $V$ 和扭曲视觉输入 $V'$ 的 logits 来抑制幻觉对象。然而， **并非所有扭曲视觉输入下的预测都是错误的**，有些预测仍然符合**基本语言逻辑**和**常识推理** 避免对所有扭曲视觉输入下的输出进行无差别惩罚，以防误伤合理的预测

APC 的核心思想是**基于模型在原始视觉输入 $V$ 下的置信度，来决定哪些 token 是合理的，并对不合理的 token 进行抑制**。

1. **定义合理 token 集合**  
   - 设定一个截断阈值 $\beta$（范围在 0 到 1 之间）。
   - 仅保留在原始视觉输入 $V$ 下**置信度较高**的 token，构成**合理 token 集合** $\mathcal{V}_{\text{head}}(y_{<t})$：
     $$
     \mathcal{V}_{\text{head}}(y_{<t}) = \{ y_t \in \mathcal{V} \mid p_{\theta}(y_t \mid v, x, y_{<t}) \geq \beta \max_{w} p_{\theta} (w \mid v, x, y_{<t}) \}
     $$
   - 这意味着：**如果一个 token 在原始视觉输入 $V$ 下的置信度较低，就不应该被模型在扭曲视觉输入 $V'$ 下产生**。

2. **调整对比目标**  
   - 在 VCD 的基础上，引入合理性约束，最终的生成公式为：
     $$
     y_t \sim \text{softmax} \left( (1 + \alpha) \logit_{\theta} (y_t \mid v, x, y_{<t}) - \alpha \logit_{\theta} (y_t \mid v', x, y_{<t}) \right)
     $$
     **但要求 $y_t$ 必须属于合理 token 集合**：
     $$
     \text{subject to } y_t \in \mathcal{V}_{\text{head}}(y_{<t})
     $$
   - 这样做可以**保证模型不会因为 VCD 误惩罚而生成不可信的 token**。

